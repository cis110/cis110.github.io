<!DOCTYPE html>
<html lang="en">

<head>
    <title>CIS 110 Grade Calculator</title>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.8.0/css/bulma.min.css">
    <script type="text/javascript">

        // assignments is an array of js objects consisting of a name denoting the id in the html,
        // a max score possible, a score received which is populated based on user input, and a weight
        // pls forgive how sloppy that is
        const midtermsSoFar = 2;
        const midtermWeight = 20.0 / midtermsSoFar; // 20% of total grade, 1 so far, so prorate at 20% for midterm 1
        const midtermMax = 110;

        const hwMax = 50;
        const hwAssignmentsSoFar = 10;
        const hwWeight = 60.0 / hwAssignmentsSoFar; // 60% of total grade, 9 assignments total

        const checkInQuizzesSoFar = 13;
        const checkInQuizzesWeight = 12.0;
        const checkInQuizzesMax = checkInQuizzesSoFar;

        const liveCodingSoFar = 11;
        const liveCodingWeight = 8.0;
        const liveCodingMax = liveCodingSoFar;

        // tracks state and is updated when students input values
        const assignments = [];
        for (i = 0; i < hwAssignmentsSoFar; i++) {
            assignments.push({ 'name': `hw0${i}`, 'max': hwMax, 'score': 0, 'weight': hwWeight });    
        }
        for (i = 0; i < midtermsSoFar; i++) {
            assignments.push({ 'name': `midterm${i}`, 'max': 110, 'score': 0, 'weight': midtermWeight });
        }
        // assignments.push({ 'name': 'code-reviews', 'max': codeReviewsMax, 'score': 0, 'weight': codeReviewsWeight });
        assignments.push({ 'name': 'check-in-quizzes', 'max': checkInQuizzesMax, 'score': 0, 'weight': checkInQuizzesWeight });
        assignments.push({ 'name': 'live-coding', 'max': liveCodingMax, 'score': 0, 'weight': liveCodingWeight });

        // as of April 1
        const letterGradeCutoffs = {
            0: 'F',
            63: 'D',
            67: 'D+',
            70: 'C-',
            73: 'C',
            77: 'C+',
            80: 'B-',
            83: 'B',
            87: 'B+',
            90: 'A-',
            93: 'A',
            97: 'A+',
        }

        // ****************************************************************************
        // html work
        // ****************************************************************************

        function fieldDivElement() {
            return $('<div class="field"></div>');
        }
        function labelElement(text) {
            return $('<label class="label"></label>').text(text);
        }
        function inputDivElement() {
            return $('<div class="control has-icons-left"></div>');
        }
        function inputInvalidElement(id) {
            return $(`<p class="help is-danger is-hidden" id="${id}">`).text('Please input your score as a valid numerical input (int or double)')
        }
        function inputElement(id) {
            return $(`<input class="input" type="text" placeholder="Score" id="${id}"></input`);
        }

        function helpElement(text) {
            return $('<p class="help"></p>').text(text);
        }
        function outputDivElement() {
            return $('<div id="grade-outputs"></div>')
        }


        function createHomeworkHtml(homeworkNumber) {
            const fieldEl = fieldDivElement();
            const labelEl = labelElement(`Homework ${homeworkNumber} (Out of 50)`);
            const inputDiv = inputDivElement();
            const inputInvalid = inputInvalidElement(`hw0${homeworkNumber}Invalid`)
            const inputEl = inputElement(`hw0${homeworkNumber}`);

            inputDiv.append(inputInvalid);
            inputDiv.append(inputEl)

            fieldEl.append(labelEl);
            fieldEl.append(inputDiv);

            return fieldEl;
        }

        function createMidtermHtml(midtermNumber) {
            const fieldEl = fieldDivElement();
            const labelEl = labelElement(`Midterm ${midtermNumber + 1} (Out of ${midtermMax})`);
            const inputDiv = inputDivElement();
            const inputInvalid = inputInvalidElement(`midterm${midtermNumber}Invalid`);
            const inputEl = inputElement(`midterm${midtermNumber}`)

            inputDiv.append(inputInvalid);
            inputDiv.append(inputEl);

            fieldEl.append(labelEl);
            fieldEl.append(inputDiv);

            return fieldEl;
        }

        function injectHomeworks() {
            for (let i = 0; i < hwAssignmentsSoFar; i++) {
                $('#assignments').append(createHomeworkHtml(i));
            }
        }

        function injectMidterms() {
            for (let i = 0; i < midtermsSoFar; i++) {
                $('#assignments').append(createMidtermHtml(i));
            }
        }

        function injectCheckInQuizzes() {
            const fieldEl = fieldDivElement();
            const labelEl = labelElement(`Check-In Quizzes (Out of ${checkInQuizzesMax} - 9 for quizzes, 2 for code reviews)`);
            const inputDiv = inputDivElement();
            const inputInvalid = inputInvalidElement(`check-in-quizzesInvalid`)
            const inputEl = inputElement(`check-in-quizzes`);
            const helpEl = helpElement(`Add up your percentages on all of the quizzes taken so far. A perfect score on one quiz is 1, a quiz not completed is 0.`)

            inputDiv.append(inputInvalid);
            inputDiv.append(inputEl)

            fieldEl.append(labelEl);
            fieldEl.append(inputDiv);
            inputDiv.append(helpEl)

            $('#assignments').append(fieldEl);
        }

        function injectLiveCoding() {
            const fieldEl = fieldDivElement();
            const labelEl = labelElement(`Live Coding (Out of ${liveCodingMax})`);
            const inputDiv = inputDivElement();
            const inputInvalid = inputInvalidElement(`live-codingInvalid`)
            const inputEl = inputElement(`live-coding`);

            inputDiv.append(inputInvalid);
            inputDiv.append(inputEl)

            fieldEl.append(labelEl);
            fieldEl.append(inputDiv);

            $('#assignments').append(fieldEl);
        }

        function injectCheckGradesButton() {
            const checkGradesHtml = $('<div class="control"></div>');
            checkGradesHtml.append($('<button class="button is-link" onclick="grade()"></button>').text("Check Grades"));
            $('#assignments').append(checkGradesHtml)
        }

        function injectGradeOutputBox() {
            const gradeOutput = $('<div class="control" id="grade-outputs"></div>');
            $('#assignments').append(gradeOutput);
        }

        // ****************************************************************************
        // business logic
        // ****************************************************************************

        function grade() {
            populateScores()

            if (validInput()) {
                percentage = 0
                
                // filter for hw and find min
                const hws = assignments.filter((assignment) => assignment.name.substring(0, 2) === 'hw');
                const minHwScore = hws.reduce((min, hw) => hw.score < min ? hw.score : min, hws[0].score);
                let firstInstanceOfMinScore = -1;
                for (let i = 0; i < hws.length; i++) {
                    const hw = hws[i];
                    if (hw.score === minHwScore) {
                        firstInstanceOfMinScore = i;
                        break;
                    }
                }

                // get the average score without the min
                let avg = 0;
                for (let i = 0; i < hws.length; i++) {
                    if (i !== firstInstanceOfMinScore) {
                        avg += Number(hws[i].score);
                    }
                }
                avg /= (hws.length - 1);

                // change min score to be avg score without min if min score is not project
                if (hws[firstInstanceOfMinScore].name !== 'hw09') {
                    hws[firstInstanceOfMinScore].score = avg;
                }
                


                // drop is accounted for, now get average overall
                assignments.forEach(assignment => {
                    thisPercentage = assignment.score / assignment.max
                    weighted = thisPercentage * assignment.weight
                    percentage += weighted
                })

                letter = 'F'
                for (var cutoff in letterGradeCutoffs) {
                    if (percentage >= cutoff) {
                        letter = letterGradeCutoffs[cutoff]
                    }
                }
                
                $("#grade-outputs").empty();
                $('#grade-outputs').append($('<p></p>').text(`Your current percentage after dropping your lowest homework is: ${percentage}`));
                $('#grade-outputs').append($('<br></br>'));
                $('#grade-outputs').append($('<p></p').text(`Your current grade is: ${letter}`));
            }
        }

        function populateScores() {
            assignments.forEach(assignment => assignment.score = $('#' + assignment.name).val())
        }

        function validInput() {
            valid = true
            for (i = 0; i < assignments.length; i++) {
                score = assignments[i].score
                id = assignments[i].name

                // score can be 5 more to account for extra credit (this is not the best solution lol)
                if (!score || score == "" || isNaN(score) || score > assignments[i].max + 5) {
                    visualizeInvalidity(id)
                    valid = false
                    console.log(`invalid input on ${assignments[i]} with score ${score} and id ${id}`)
                } else {
                    visualizeValidity(id)
                }
            }
            console.log(assignments, valid) // for debugging
            return valid
        }

        function visualizeInvalidity(id) {
            $('#' + id + 'Invalid').removeClass('is-hidden')
            $('#' + id + 'Invalid').addClass('is-active')
            $('#' + id).removeClass('is-success')
            $('#' + id).addClass('is-danger')
        }

        function visualizeValidity(id) {
            $('#' + id + 'Invalid').removeClass('is-active')
            $('#' + id + 'Invalid').addClass('is-hidden')
            $('#' + id).removeClass('is-danger')
            $('#' + id).addClass('is-success')
        }

        function clearFields() {
            assignments.forEach(assignment => {
                id = assignment.name
                $('#' + id).val('')
                $('#' + id).removeClass('is-success')
                $('#' + id).addClass('is-info')
            })
        }

        $(document).ready(function () {
            clearFields();

            injectHomeworks();
            injectMidterms();
            injectCheckInQuizzes();
            injectLiveCoding();
            injectCheckGradesButton();
            injectGradeOutputBox();

        })
    </script>

    <style>
        div {
            /* Provides some padding that bulma doesn't do */
            padding-top: 5px;
            padding-left: 5px;
            padding-right: 5px;
            padding-bottom: 5px;
        }

        .main {
            display: flex;
            min-height: 100vh;
            flex-direction: column;
        }

        .section {
            flex: 1;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 class="title">
            CIS 110 Grade Calculator
        </h1>
        <p>
            This is meant as a way for students to check their standing in the course prior to the P/F deadline. After the P/F deadline,
            we will continue to maintain and update this page. The grade cutoffs have been
            established as of October 30, 2020 and are prorated to what we believe the cutoffs will be at the end of the
            semester. This in no way is a guarantee of your final grade in the course.</br></br>

            If you received extra credit on any homework, you should put in your score with that extra credit included.
            For example, if you got a 50/50 on hw02 but then got 1 point of extra credit, you should put 51.</br></br>

            Please note that we have built this to assume your course performance will not change. In other words, if you averaged a 85%
            on the first 5 homework assignments, we are implicitly assuming you will receive an 85% on the rest of the homework in our calculations.
            This has been updated as of December 14, 2020.</br></br>
        </p>
        <p>
            Return to the <a href="https://cis.upenn.edu/~cis110/current">CIS 110 Home Page</a>
        </p>
        <div class="box" id="assignments">
            <!-- this is dynamically created above. -->
        </div>
    </div>
</body>


</html>